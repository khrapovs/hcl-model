image: python:3.7

stages:
  - tests
  - docs
  - build_wheel
  - push_wheel

variables:
  NEXUS_REPOSITORY: "nexus.signintra.com/repository/GDSA-PyPi"

before_script:
  - export PYTHONPATH=$(pwd)/src
  - pip install pipenv
  - pipenv install --system --deploy --skip-lock

Tests:
    stage: tests
    script:
      - python setup.py test

Docs:
    stage: docs
    script:
      - python setup.py docs

Build Python Wheel:
    stage: build_wheel
    script:
        - python setup.py bdist_wheel
    artifacts:
      paths:
        - ./dist/*.whl
      expire_in: 30 minutes

Push Python Wheel:
    stage: push_wheel
    script:
      - twine upload -u ${NEXUS_LOGIN} -p ${NEXUS_PASSWORD} --repository-url https://${NEXUS_REPOSITORY}/ dist/*
    only:
      changes:
        - src/**/*
        - .gitlab-ci.yml
      refs:
        - master
