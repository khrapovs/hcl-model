image: python:3.9

stages:
  - tests_and_docs
  - publish_package_and_docs

variables:
  NEXUS_REPOSITORY: "nexus.signintra.com/repository/GDSA-PyPi"
  NEXUS_STATIC: "nexus.signintra.com/repository/GDSA-static"
  PACKAGE_NAME: "hcl-model"

Tests:
    stage: tests_and_docs
    before_script:
      - pip install -e .[testing]
    script:
      - pytest

Docs:
    stage: tests_and_docs
    before_script:
      - pip install -e .[docs]
    script:
      - python setup.py docs -W
    artifacts:
      paths:
        - ./build/sphinx/html/*
      expire_in: 30 minutes

Build and Push Python Wheel:
  stage: publish_package_and_docs
  before_script:
    - python setup.py bdist_wheel
    - pip install twine
  script:
    - twine upload -u ${NEXUS_USER} -p ${NEXUS_PASSWORD} --repository-url https://${NEXUS_REPOSITORY}/ dist/*
  only:
    refs:
      - tags

Push static documentation:
  stage: publish_package_and_docs
  script:
    - cd build/sphinx/html
    - find . -type f -exec curl -u ${NEXUS_USER}:${NEXUS_PASSWORD}
      --ftp-create-dirs -T {} https://${NEXUS_STATIC}/packages/${PACKAGE_NAME}/docs/{} \;
  only:
    refs:
      - tags
